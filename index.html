<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Travel App 0.35</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />

    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.cheaplayerat@0.1.2/Leaflet.CheapLayerAt.min.js"></script>
    <!-- prettier-ignore -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/hosuaby/Leaflet.SmoothMarkerBouncing@v3.0.2/dist/bundle.js" crossorigin="anonymous" ></script>

    <div id="map"></div>

    <button id="map_tile_layer_A" class="layer_button layer_1">layer 1</button>
    <button id="map_tile_layer_B" class="layer_button layer_2">layer 2</button>
    <button id="map_tile_layer_C" class="layer_button layer_3">layer 3</button>
    <button id="map_tile_layer_D" class="layer_button layer_4">layer 4</button>

    <button id="map_tile_addon_labels" class="layer_button addon_labels">labels</button>
    <button id="map_tile_addon_borders" class="layer_button addon_borders">borders</button>
    <button id="map_tile_addon_train" class="layer_button addon_train">train</button>
    <button id="map_tile_addon_cycling" class="layer_button addon_cycling">cycling</button>

    <button id="home_button_main" class="home_button home_main">main</button>
    <button id="home_button_zoom" class="home_button home_zoom hidden">zoom</button>
    <button id="home_button_geolocation" class="home_button home_geolocation hidden">location</button>
    <button id="home_button_manual" class="home_button home_manual hidden">manual</button>

    <input type="color" id="home_color_picker" value="#8AFF14" />
    <div>
      <input type="range" id="home_opacity_slider" min="0" max="1" step="0.05" value="0.5" />
    </div>

    <div class="app_version">ver: 0 . 35</div>

    <div id="info_popup" style="display: none">
      <span id="close_info_popup">&times;</span>
      <p id="info_popup_text"></p>
    </div>

    <script type="module">
      // ---------- 1.
      // ---------- 2.
      // ---------- 3.
      // ---------- 4.
      // ---------- 5.

      // ↓ Leaflet Map ↓

      import leafletConfig from "./leafletConfig.js";

      const { L } = window;

      const home_icon = L.icon({
        iconUrl: "content/icons/home_icon.png",
        iconSize: [48, 48],
        iconAnchor: [24, 24],
      });

      const map = L.map("map", { zoomControl: false }).setView([50, 10], 6);

      let home_highlight_color = "#8AFF14";
      let home_highlight_opacity = 0.5;

      let active_Home_Marker = "";

      const { mapTileLayer_A, mapTileLayer_B, mapTileLayer_C, mapTileLayer_D } = leafletConfig.tilemaps;
      const { trainsAddon, cyclingAddon, bordersAddon, labelsAddon } = leafletConfig.addons;

      const mapTileLayers = L.layerGroup([mapTileLayer_B]).addTo(map);
      const mapMarkers = L.layerGroup().addTo(map);

      const map_tile_layer_A = document.querySelector("#map_tile_layer_A");
      const map_tile_layer_B = document.querySelector("#map_tile_layer_B");
      const map_tile_layer_C = document.querySelector("#map_tile_layer_C");
      const map_tile_layer_D = document.querySelector("#map_tile_layer_D");

      const map_tile_addon_labels = document.querySelector("#map_tile_addon_labels");
      const map_tile_addon_borders = document.querySelector("#map_tile_addon_borders");
      const map_tile_addon_train = document.querySelector("#map_tile_addon_train");
      const map_tile_addon_cycling = document.querySelector("#map_tile_addon_cycling");

      const home_color_picker = document.getElementById("home_color_picker");
      const home_opacity_slider = document.getElementById("home_opacity_slider");

      const popupDiv = document.getElementById("info_popup");
      const info_popup_text = document.getElementById("info_popup_text");
      const close_info_popup = document.getElementById("close_info_popup");

      // // ↓ Leaflet Map / Tiles Change ↓

      map_tile_layer_A.addEventListener("click", () => switchTileMap(mapTileLayer_A));
      map_tile_layer_B.addEventListener("click", () => switchTileMap(mapTileLayer_B));
      map_tile_layer_C.addEventListener("click", () => switchTileMap(mapTileLayer_C));
      map_tile_layer_D.addEventListener("click", () => switchTileMap(mapTileLayer_D));

      map_tile_addon_labels.addEventListener("click", () => switchTileAddon(labelsAddon));
      map_tile_addon_borders.addEventListener("click", () => switchTileAddon(bordersAddon));
      map_tile_addon_train.addEventListener("click", () => switchTileAddon(trainsAddon));
      map_tile_addon_cycling.addEventListener("click", () => switchTileAddon(cyclingAddon));

      // // ↑ Leaflet Map / Tiles Change ↑

      function switchTileAddon(tile_addon) {
        if (map.hasLayer(tile_addon)) {
          tile_addon.removeFrom(map);
        } else {
          tile_addon.addTo(map);
        }
      }

      function switchTileMap(layer) {
        mapTileLayers.clearLayers();
        mapTileLayers.addLayer(layer);
      }

      // // ↓ Leaflet Map / Custom Home Highlight Color + opacity ↓

      home_color_picker.addEventListener("input", function () {
        home_highlight_color = home_color_picker.value;
        // countriesLayers.setStyle({ fillColor: home_highlight_color });  będzie w przyszłości problem z kolorowaniem wszystkich państw zamiast tylko jednego
      });

      home_opacity_slider.addEventListener("input", function () {
        home_highlight_opacity = parseFloat(home_opacity_slider.value);
      });

      // // ↑ Leaflet Map / Custom Home Highlight Color + opacity ↑

      // ↑ Leaflet Map  ↑

      // ↓ Home ↓

      let home_button_manual_click = false;
      let home_button_geolocation_click = false;

      const home_button_zoom = document.getElementById("home_button_zoom");
      const home_button_geolocation = document.getElementById("home_button_geolocation");
      const home_button_manual = document.getElementById("home_button_manual");

      // // ↓ Home / Info Popup ↓

      function showInfoPopup(text) {
        info_popup_text.textContent = text;
        popupDiv.style.display = "block";
      }

      function closeInfoPopup() {
        popupDiv.style.display = "none";
      }
      close_info_popup.addEventListener("click", closeInfoPopup);

      // // ↑ Home / Info Popup ↑

      // ↑ Home ↑

      // ↓ GeoJSON ↓

      let countriesLayers = "";

      // // ↓ GeoJSON Initialization + color ↓

      fetch("content/data/countries.geojson")
        .then((response) => response.json())
        .then((data) => {
          countriesLayers = L.geoJSON(data, {
            style() {
              return {
                fillColor: home_highlight_color,
                weight: 0,
                opacity: 0,
                fillOpacity: 0,
                color: "#ffffff",
              };
            },
            onEachFeature(feature, layer) {
              layer.on("click", () => {
                if (home_button_manual_click === true) {
                  layer.setStyle({
                    fillColor: home_highlight_color,
                    fillOpacity: home_highlight_opacity,
                    color: "red",
                    weight: 0.5,
                  });
                }
              });
            },
          }).addTo(map);
        });

      // // ↑ GeoJSON Initialization + color ↑

      // // ↓ GeoJSON / Geolocation on Button Click ↓

      home_button_geolocation.addEventListener("click", () => {
        home_button_manual_click = false;
        home_button_geolocation_click = true;

        HomeMarkerClear();
        HomeHighlightClear();

        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition((position) => {
            const { latitude, longitude } = position.coords;

            const latlng = L.latLng(latitude, longitude);
            const containerPoint = map.latLngToContainerPoint(latlng);
            const layerAtLatLng = map.getLayerAt(containerPoint);
            layerAtLatLng.setStyle({
              fillOpacity: home_highlight_opacity,
              fillColor: home_highlight_color,
              color: "green",
              weight: 0.5,
            });

            active_Home_Marker = L.marker([latitude, longitude], {
              icon: home_icon,
              id: "home_marker",
            });
            active_Home_Marker.addTo(mapMarkers).bounce(1);
          });
        }
      });

      // // ↑ GeoJSON / Geolocation on Button Click ↑

      // // ↓ GeoJSON / Manual Location ↓

      home_button_manual.addEventListener("click", () => {
        home_button_manual_click = true;

        HomeMarkerClear();
        HomeHighlightClear();

        const mapClickListener = (e) => {
          const clickedLatLng = e.latlng;

          if (home_button_manual_click === true) {
            active_Home_Marker = L.marker(clickedLatLng, {
              icon: home_icon,
              id: "home_marker",
            });
            active_Home_Marker.addTo(mapMarkers).bounce(1);
          }

          home_button_manual_click = false;

          map.off("click", mapClickListener);
        };
        map.on("click", mapClickListener);
      });

      // // ↑ GeoJSON / Manual Location ↑

      // // ↓ GeoJSON / Home Button Center Marker ↓

      home_button_zoom.addEventListener("click", () => {
        if (active_Home_Marker) {
          map.setView(active_Home_Marker.getLatLng(), 7);
        } else {
          showInfoPopup("Home location not set!");
        }
      });

      // // ↑ GeoJSON / Home Button Center Marker ↑

      function HomeHighlightClear() {
        if (home_button_manual_click === true || home_button_geolocation_click === true) {
          countriesLayers.eachLayer((layer) => {
            layer.setStyle({ fillOpacity: 0, color: "transparent", weight: 0 });
          });
        }
      }

      function HomeMarkerClear() {
        if (active_Home_Marker) {
          active_Home_Marker.remove();
          active_Home_Marker = null;
        }
      }

      // ↑ GeoJSON ↑

      //   window.addEventListener("load", function () {
      //       const cover = document.getElementById("cover");
      //       cover.style.display = "none";
      //   });
    </script>
  </body>
</html>
